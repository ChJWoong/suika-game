<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta charset="utf-8" />
    <title></title>
  </head>
  <body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.js"></script>
    <script>
      // module aliases
      var Engine = Matter.Engine,
        Render = Matter.Render,
        Runner = Matter.Runner,
        Bodies = Matter.Bodies,
        Composite = Matter.Composite,
        World = Matter.World,
        Body = Matter.Body,
        Events = Matter.Events;

      // create an engine
      var engine = Engine.create();

      // create a renderer
      var render = Render.create({
        element: document.body,
        engine: engine,
        options: {
          wireframes: false,
          background: "#F7F4C8",
          width: 620,
          height: 850,
        },
      });

      const world = engine.world;

      const leftWall = Bodies.rectangle(15, 395, 30, 790, {
        isStatic: true,
        render: { fillStyle: "#E6B143" },
      });

      const rightWall = Bodies.rectangle(605, 395, 30, 790, {
        isStatic: true,
        render: { fillStyle: "#E6B143" },
      });

      const ground = Bodies.rectangle(310, 820, 620, 60, {
        isStatic: true,
        render: { fillStyle: "#E6B143" },
      });

      const topLine = Bodies.rectangle(310, 150, 620, 2, {
        isStatic: true,
        isSensor: true,
        render: { fillStyle: "#E6B143" },
      });

      World.add(world, [leftWall, rightWall, ground, topLine]);
      // run the renderer
      Render.run(render);

      // create runner
      var runner = Runner.create();

      // run the engine
      Runner.run(runner, engine);

      let currentBody = null;
      let currentFruit = null;
      let disable = false;
      let interval = null;
      let numSuika = 0;

      const FRUITS = [
        {
          name: "images/00_cherry",
          color: "#812F2F",
          radius: 33 / 2,
        },
        {
          name: "images/01_strawberry",
          color: "#FD0000",
          radius: 48 / 2,
        },
        {
          name: "images/02_grape",
          color: "#8204FF",
          radius: 61 / 2,
        },
        {
          name: "images/03_gyool",
          color: "#FFBF28",
          radius: 69 / 2,
        },
        {
          name: "images/04_orange",
          color: "#FFA228",
          radius: 89 / 2,
        },
        {
          name: "images/05_apple",
          color: "#FF7B4A",
          radius: 114 / 2,
        },
        {
          name: "images/06_pear",
          color: "#FDFFB3",
          radius: 129 / 2,
        },
        {
          name: "images/07_peach",
          color: "#FFB3E1",
          radius: 156 / 2,
        },
        {
          name: "images/08_pineapple",
          color: "#94FF89",
          radius: 177 / 2,
        },
        {
          name: "images/09_melon",
          color: "#1AFF00",
          radius: 220 / 2,
        },
        {
          name: "images/10_watermelon",
          color: "#0066FF",
          radius: 259 / 2,
        },
      ];

      function addFruit() {
        let index = Math.floor(Math.random() * 5);
        const fruit = FRUITS[index];

        const body = Bodies.circle(300, 50, fruit.radius * 1.2, {
          index: index,
          isSleeping: true,
          //  texture: `${fruit.name}.png`,
          render: {
            //fillStyle: fruit.color,
            sprite: { texture: `${fruit.name}.png`, xScale: 1.2, yScale: 1.2 },
          },
          restitution: 0.3,
        });

        currentBody = body;
        currentFruit = fruit;

        World.add(world, body);
      }

      window.onkeydown = function (event) {
        if (disable == false) {
          switch (event.code) {
            case "KeyA":
              if (interval) {
                return;
              }

              interval = setInterval(function () {
                if (currentBody.position.x - currentFruit.radius > 30) {
                  Body.setPosition(currentBody, { x: currentBody.position.x - 10, y: currentBody.position.y });
                }
              }, 20);

              break;

            case "KeyD":
              if (interval) {
                return;
              }
              interval = setInterval(function () {
                if (currentBody.position.x + currentFruit.radius < 590) {
                  Body.setPosition(currentBody, { x: currentBody.position.x + 10, y: currentBody.position.y });
                }
              }, 20);

              break;

            case "KeyS":
              currentBody.isSleeping = false;
              disable = true;
              setTimeout(function () {
                addFruit();
                disable = false;
              }, 500);

              break;
          }
        }
      };

      window.onkeyup = function (event) {
        switch (event.code) {
          case "KeyA":
          case "KeyD":
            clearInterval(interval);
            interval = null;
        }
      };

      Events.on(engine, "collisionStart", function (event) {
        event.pairs.forEach(function (collision) {
          if (collision.bodyA.index === collision.bodyB.index) {
            const index = collision.bodyA.index;

            if (index === FRUITS.length - 1) {
              return;
            }

            World.remove(world, [collision.bodyA, collision.bodyB]);

            const newFruit = FRUITS[index + 1];

            const newBody = Bodies.circle(collision.collision.supports[0].x, collision.collision.supports[0].y, newFruit.radius * 1.2, {
              index: index + 1,
              isSleeping: false,
              render: {
                fillStyle: newFruit.color,
                sprite: { texture: `${newFruit.name}.png`, xScale: 1.2, yScale: 1.2 },
              },
              restitution: 0.3,
            });

            World.add(world, newBody);
            if (newBody.index == 10) {
              numSuika += 1;
            }
            if (numSuika == 1) {
              setTimeout(function () {
                console.log(numSuika);
                alert("수박 완성!");
              }, 500);
            }
          }
        });
      });

      addFruit();
    </script>
  </body>
</html>
